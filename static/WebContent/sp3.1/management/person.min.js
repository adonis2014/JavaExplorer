app=window.app||{};constant=window.constant||{};constant.servletPath=location.pathname.substring(0,location.pathname.indexOf("/management/person"));constant.currentDate=new Date();constant.localOffsetMinute=constant.currentDate.getTimezoneOffset();constant.localOffsetMillisecond=constant.localOffsetMinute*60000;constant.offsetMillisecond=3600000;PersonModel=Backbone.Model.extend({defaults:{"name":null,"sex":null,"birthday":null,"breakfastTime":null,"createTime":null,"height":null,"languages":null,"note":null,"salary":null,"active":null,"version":null},initialize:function(a,b){this.original=$.extend(true,{},this.attributes)},parse:function(a,b){if(a.processSuccessfully==null){var c=a.birthday.match(/\d+/g);a.birthday=new Date(Date.UTC(c[0],parseInt(c[1])-1,c[2]));c=a.breakfastTime.match(/\d+/g);a.breakfastTime=new Date(Date.UTC(0,0,0,c[0],c[1],c[2]));a.createTime=new Date(a.createTime+constant.localOffsetMillisecond);if(!(a.languages instanceof Array)){a.languages=[]}a.languages.sort();return a}else{return undefined}},toJSON:function(a){return Backbone.Model.prototype.toJSON.apply(this,arguments)},validate:function(a,b){if(a.id==null){return"id is required!"}if(a.name==null){return"name is required!"}if(a.sex!="male"&&a.sex!="female"){return"argument of sex is wrong!"}if(!(a.birthday instanceof Date)){return"argument of birthday is wrong!"}if(!(a.breakfastTime instanceof Date)){return"argument of breakfastTime is wrong!"}if(typeof a.height!=="number"||isNaN(a.salary)){return"argument of salary is wrong!"}if(typeof a.salary!=="number"||isNaN(a.salary)||/[\.-]/.test(a.salary+"")){return"argument of salary is wrong!"}if(typeof a.active!=="boolean"){return"argument of active is wrong!"}return undefined}});PersonCollection=Backbone.Collection.extend({model:PersonModel,url:constant.servletPath+"/person",initialize:function(a,b){},parse:function(a){return a.persons}});BatchUpdatePersonCollection=Backbone.Collection.extend({model:PersonModel,url:constant.servletPath+"/person",initialize:function(a,b){},batchUpdate:function(h){h=h||{};var i=h.success;var j=h.error;h.success=function(d,e,f){var g=[];$.each(e.actionStatus,function(a,b){if(b.processSuccessfully){var c=d.get(b.id);c.original=$.extend(true,{},c.attributes);c.trigger("change",c,f);if(c){g.push(c);d.remove(c,{silent:true})}}});if(g.length>0){d.trigger("remove",g,d,f)}if(i){i(d,e,f)}};h.error=function(a,b,c){if(j){j(a,b,c)}};var k=this.sync("update",this,h);return k},toJSON:function(a){var b=Backbone.Collection.prototype.toJSON.apply(this,arguments);var c={};c.personCommands=b;return c},parse:function(a){return a.persons}});PersonTbodyView=Backbone.View.extend({initialize:function(d){this.collection.on("reset",this.collectionResetListener,this);this.collection.fetch({success:function(a,b,c){alert("fetch data success!")},error:function(a,b,c){alert("person fetch error!")}})},render:function(){this.$el.empty();this.collection.each($.proxy(function(a,b,c){var d=new PersonTrView({model:a});this.$el.append(d.render().$el)}),this);return this},collectionResetListener:function(a,b){this.render()}});PersonTrView=Backbone.View.extend({template:_.template("<td><span class='id-style'><%=id%></span></td>"+"<td><%=name%></td>"+"<td><%=sex%></td>"+"<td><%=birthday.formatUTC('yyyy年MM月dd日')%></td>"+"<td><%=breakfastTime.formatUTC('hh时mm分ss秒')%></td>"+"<td><%=createTime.formatUTC('yyyy-MM-dd hh:mm:ss')%></td>"+"<td><%=height%></td>"+"<td><ul><%_.each(languages,function(name){print('<li>'+name+'</li>')})%></ul></td>"+"<td><%=salary%></td>"+"<td><%=note%></td>"+"<td><%=version%></td>"+"<td><%=active?'是':'否'%></td>"+"<td><button type='button' class='modifyBtn'>修改</button>"+"<button type='button' class='saveBtn' disabled='disabled'>保存</button>"+"<button type='button' class='resetBtn' disabled='disabled'>还原</button>"+"<button type='button' class='deleteBtn'>删除</button></td>"),tagName:"tr",events:{"click button.modifyBtn":"modifyPersonInfoAction","click button.saveBtn":"savePersonInfoAction","click button.resetBtn":"resetPersonInfoAction","click button.deleteBtn":"deletePersonInfoAction"},initialize:function(a){this.model.on("change",this.changeAttributeListener,this);this.model.on("invalid",this.modelValidateFailedListener,this);this.model.on("destroy",this.modelDestroyListener,this)},changeAttributeListener:function(a){this.render();if(!_.isEqual(this.model.original,this.model.attributes)){$(".id-style",this.$el).css({color:"red","font-weight":"bold"});$(":button:gt(0)",this.$el).prop("disabled",false);app.batchUpdatePersonCollection.push(this.model)}else{app.batchUpdatePersonCollection.remove(this.model)}},render:function(){this.$el.html(this.template(this.model.attributes));return this},modifyPersonInfoAction:function(a){app.modifyPersonview.setModel(this.model);$("#dialog-edit-person").dialog("open")},savePersonInfoAction:function(d){this.model.save(null,{success:function(a,b,c){a.original=$.extend(true,{},a.attributes);a.trigger("change",a);alert("save complete!")},error:function(a,b,c){alert("save error!")}})},resetPersonInfoAction:function(a){var b=$.extend(true,{},this.model.original);delete b.id;this.model.set(b)},deletePersonInfoAction:function(d){if(confirm("是否要删除所选定的记录？")){this.model.destroy({success:$.proxy(function(a,b,c){if(b.processSuccessfully){this.remove();alert("delete success!")}else{alert("delete error!")}},this),error:function(a,b,c){alert("delete error!")}})}},modelValidateFailedListener:function(a,b,c){alert("Model validate failed! "+b)},modelDestroyListener:function(a,b,c){}});EditPersonFromView=Backbone.View.extend({template:_.template("<form action=''>"+"id:<input name='id' type='text' value='<%=id%>' disabled='disabled'/><br/>"+"姓名:<input name='name' type='text' value='<%=name%>'/><br/>"+"性别:男<input name='sex' type='radio' value='male' <%if(sex=='male'){print('checked=\"checked\"')}%>/>女<input name='sex' type='radio' value='female' <%if(sex=='female'){print('checked=\"checked\"')}%>/><br/>"+"生日:<input name='birthday' type='text' class='datepicker' readonly='readonly' value='<%=birthday.formatUTC('yyyy-MM-dd')%>'/><br/>"+"早餐时间:<input name='breakfastTime' type='text' value='<%=breakfastTime.formatUTC('hh:mm:ss')%>'/><br/>"+"身高:<input name='height' type='text' value='<%=height%>'/><br/>"+"语言:"+"英文<input name='languages' type='checkbox' value='english' <%if(_.find(languages,function(element){return element=='english'})){print('checked=\"checked\"')}%>/>"+"中文<input name='languages' type='checkbox'S value='chinese' <%if(_.find(languages,function(element){return element=='chinese'})){print('checked=\"checked\"')}%>/>"+"日文<input name='languages' type='checkbox' value='japanese' <%if(_.find(languages,function(element){return element=='japanese'})){print('checked=\"checked\"')}%>/>"+"韩文<input name='languages' type='checkbox' value='korean' <%if(_.find(languages,function(element){return element=='korean'})){print('checked=\"checked\"')}%>/>"+"其它<input name='languages' type='checkbox' value='other' <%if(_.find(languages,function(element){return element=='other'})){print('checked=\"checked\"')}%>/><br/>"+"收入:<input name='salary' type='text' value='<%=salary%>'/><br/>"+"备注:<textarea rows='5' cols='20' name='note'><%=note%></textarea><br/>"+"激活:是<input name='active' type='radio' value='true' <%=active?'checked=\"checked\"':''%>/>否<input name='active' type='radio' value='false' <%=active?'':'checked=\"checked\"'%>/>"+"</form>"),events:{"click button.ui-button-text-only:first":"submitAction","click button.ui-button-text-only:eq(1)":"cancelAction","click button.ui-button-text-only:last":"showDataAction","change input[name='name'],textarea[name='note']":"changeTextAction","change input[name='birthday']":"changeDateAction","change input[name='breakfastTime']":"changeTimeAction","keyup input[name='breakfastTime']":"validateTimeAction","change input[name='height']":"changeFloatAction","change input[name='salary']":"changeIntAction","change input:radio":"changeRadioAction","change input[name='languages']:checkbox":"changeCheckboxAction"},initialize:function(a){this.$contentPanel=$("#dialog-edit-person",this.$el);this.model.on("invalid",this.modelValidateFailedListener,this);this.model.on("change",this.changeAttributeListener,this)},setModel:function(a){this.model.set($.extend(true,{},a.attributes))},changeAttributeListener:function(a){this.render()},render:function(){this.$contentPanel.html(this.template(this.model.attributes));$("input.datepicker",this.$contentPanel).datepicker({dateFormat:"yy-mm-dd"});return this},submitAction:function(a){var b=app.personCollection.get(this.model.id);var c=_.clone(this.model.attributes);delete c.id;b.set(c)},cancelAction:function(a){},showDataAction:function(a){alert(this.model.toJSON())},changeTextAction:function(a){var b=$(a.currentTarget);var c=b.attr("name");this.model.set(c,b.val(),{validate:true,silent:true})},changeDateAction:function(a){var b=$(a.currentTarget);var c=b.attr("name");var d=b.val().match(/\d+/g);var e=new Date(Date.UTC(d[0],parseInt(d[1])-1,d[2]));this.model.set(c,e,{validate:true,silent:true})},changeTimeAction:function(a){var b=$(a.currentTarget);var c=b.attr("name");var d=b.val().match(/\d+/g);var e=new Date(Date.UTC(0,0,0,d[0],d[1],d[2]));this.model.set(c,e,{validate:true,silent:true});b.val(this.model.get(c).formatUTC('hh:mm:ss'))},validateTimeAction:function(a){var b=$(a.currentTarget);var c=b.val();if(!/^\d{2}:\d{2}:\d{2}$/.test(c)){b.val(this.model.get("breakfastTime").formatUTC('hh:mm:ss'));return false}},changeFloatAction:function(a){var b=$(a.currentTarget);var c=b.attr("name");this.model.set(c,parseFloat(b.val()),{validate:true,silent:true});b.val(this.model.get(c))},changeIntAction:function(a){var b=$(a.currentTarget);var c=b.attr("name");this.model.set(c,parseFloat(b.val()),{validate:true,silent:true});b.val(this.model.get(c))},changeRadioAction:function(a){this.changeTextAction(a)},changeCheckboxAction:function(c){var d=$(c.currentTarget);var e=d.attr("name");var f=[];$("input[name='"+e+"']:checked",this.$contentPanel).each(function(a,b){f.push($(b).val())});f.sort();this.model.set(e,f,{validate:true,silent:true})},modelValidateFailedListener:function(a,b,c){this.render();alert("Model validate failed!\n"+b)}});PageHeadView=Backbone.View.extend({template:_.template("<span style='margin-left: 90%'></span><button type='button' disabled='disabled'>批量更新</button>"),events:{"click button":"batchUpdateAction"},tagName:"p",initialize:function(a){this.$el.css({width:"100%"});this.collection.on("add remove",this.updateBatchUpdatePersonCollectionListener,this)},render:function(){this.$el.html(this.template());return this},updateBatchUpdatePersonCollectionListener:function(a,b,c){$("button",this.$el).prop("disabled",b.length===0)},batchUpdateAction:function(f){if(confirm("是否要批量更新?")){this.collection.batchUpdate({success:function(b,c,d){var e=_.filter(c.actionStatus,function(a){return a.processSuccessfully}).length;alert("成功更新"+e+"条记录!")}})}}});$().ready(function(){app.personCollection=new PersonCollection();app.batchUpdatePersonCollection=new BatchUpdatePersonCollection();app.personTbodyView=new PersonTbodyView({collection:app.personCollection,el:$("#personTable>tbody")});app.pageHeadView=new PageHeadView({collection:app.batchUpdatePersonCollection});$("#personTable").before(app.pageHeadView.render().$el);$("#dialog-edit-person").dialog({autoOpen:false,width:400,buttons:{"提交":function(){$(this).dialog("close")},"取消":function(){$(this).dialog("close")},"查看数据":function(){}}});app.modifyPersonview=new EditPersonFromView({el:$("#dialog-edit-person").parent(),model:new PersonModel()})});